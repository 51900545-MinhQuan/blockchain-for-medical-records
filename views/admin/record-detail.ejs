<%- include('./partials/header') %>

<style>
  .custom-control {
    position: relative;
  }
  .custom-control-input {
    z-index: 100 !important;
    cursor: pointer;
  }
  .custom-control-label {
    cursor: pointer;
  }
</style>

<div class="pcoded-main-container">
  <div class="pcoded-content">
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="m-b-10">Chi tiết bệnh án</h5>
            </div>
            <ul class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="/admin"><i class="feather icon-home"></i></a>
              </li>
              <li class="breadcrumb-item">
                <a href="/admin/records">Danh sách bệnh án</a>
              </li>
              <li class="breadcrumb-item"><a>Chi tiết</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-header">
            <h5>Thông tin bệnh án: <%= record.recordCode %></h5>
            <button
              id="btnVerifyIntegrity"
              class="btn btn-warning btn-sm float-right"
              data-id="<%= record._id %>"
            >
              <i class="feather icon-shield"></i> Kiểm tra tính toàn vẹn
            </button>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="font-weight-bold">Mã bệnh án:</label>
                  <p><%= record.recordCode %></p>
                </div>
                <div class="form-group">
                  <label class="font-weight-bold">Ngày khám:</label>
                  <p><%= record.visitDate ? record.visitDate.toLocaleDateString('vi-VN') : '' %></p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="font-weight-bold">Bác sĩ:</label>
                  <p><%= record.doctorID ? record.doctorID.fullname : 'N/A' %> - <%= record.doctorID ? record.doctorID.linkedDoctorCode : 'N/A' %></p>
                </div>
                <div class="form-group">
                  <label class="font-weight-bold">Bệnh nhân:</label>
                  <p><%= record.patientID ? record.patientID.fullname : 'N/A' %> - <%= record.patientID ? record.patientID.patientCode : 'N/A' %></p>
                </div>
              </div>
            </div>
            <div class="row mt-3">
                  <div class="col-12">
                <label class="font-weight-bold">Lịch sử cập nhật:</label>
                <ul class="list-unstyled">
                  <% if (typeof logs !== 'undefined' && logs.length > 0) { %>
                    <% logs.forEach(log => { %>
                      <li>
                        <b><%= moment(log.created_at).format("DD/MM/YYYY HH:mm:ss") %></b>: 
                        <% 
                          let eventName = log.event;
                          if (log.event === 'RecordAdded') eventName = 'Tạo bệnh án';
                          else if (log.event === 'RecordUpdated') eventName = 'Chỉnh sửa bệnh án';
                          else if (log.event === 'AccessAttempt') eventName = `Truy cập bệnh án (${log.data.accessGranted ? 'Thành công' : 'Thất bại'})`;
                          else if (log.event === 'RecordHashUpdatedByAdmin') {
                            eventName = 'Admin rollback bệnh án';
                            let time = (log.data && log.data.versionDate) ? log.data.versionDate : ((log.data && log.data.updated_at) ? log.data.updated_at : log.created_at);
                            eventName += ` về phiên bản ${moment(time).format("DD/MM/YYYY HH:mm:ss")}`;
                          }
                          else if (log.event === 'AccessGranted') eventName = 'Cấp quyền truy cập';
                          else if (log.event === 'AccessRevoked') eventName = 'Thu hồi quyền truy cập';
                        %>
                        <%= eventName %> 
                        <%= (log.event === 'RecordHashUpdatedByAdmin') ? '' : ((log.event === 'AccessGranted' || log.event === 'AccessRevoked') ? 'cho' : 'bởi') %> 
                        <% 
                          let doctorDisplay = "";
                          if (log.event === 'RecordHashUpdatedByAdmin') {
                            doctorDisplay = "";
                          } else if (log.data && log.data.doctor) {
                            if (typeof log.data.doctor === 'string') {
                              doctorDisplay = log.data.doctor;
                            } else {
                              doctorDisplay = (log.data.doctor.fullname || '') + ' - ' + (log.data.doctor.code || log.data.doctor.doctorCode || '');
                            }
                          }
                        %>
                        <b><%= doctorDisplay %></b>
                      </li>
                    <% }) %>
                  <% } else { %>
                    <li class="text-muted font-italic">Chưa có dữ liệu lịch sử.</li>
                  <% } %>
                </ul>
                <% if (typeof totalLogPages !== 'undefined' && totalLogPages > 1) { %>
                  <div class="d-flex justify-content-center mt-2">
                    <nav aria-label="Log navigation">
                      <ul class="pagination pagination-sm mb-0">
                        <li class="page-item <%= currentLogPage <= 1 ? 'disabled' : '' %>">
                          <a class="page-link" href="?logPage=<%= currentLogPage - 1 %>" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                        <li class="page-item disabled">
                          <span class="page-link text-muted"><%= currentLogPage %> / <%= totalLogPages %></span>
                        </li>
                        <li class="page-item <%= currentLogPage >= totalLogPages ? 'disabled' : '' %>">
                          <a class="page-link" href="?logPage=<%= currentLogPage + 1 %>" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                      </ul>
                    </nav>
                  </div>
                <% } %>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <label class="font-weight-bold">Lịch sử phiên bản bệnh án:</label>
                <div class="list-group">
                  <% if (typeof versions !== 'undefined' && versions.length > 0) { %>
                    <% versions.forEach(version => { %>
                      <div class="list-group-item">
                        <div class="custom-control custom-radio">
                          <input type="radio" id="version_<%= version.version %>" name="versionSelect" class="custom-control-input" <%= version.version === record.currentVersion ? 'checked' : '' %>>
                          <label class="custom-control-label font-weight-bold" for="version_<%= version.version %>">
                            Phiên bản #<%= version.version %> <%= version.version === record.currentVersion ? '(Hiện tại)' : '' %>
                          </label>
                        </div>
                        <div class="ml-4">
                          <div>- Thời gian: <%= moment(version.createdAt).format("DD/MM/YYYY HH:mm:ss") %></div>
                          <div>- Bác sĩ: <%= version.updatedBy ? version.updatedBy.fullname : 'N/A' %> - <%= version.updatedBy ? version.updatedBy.linkedDoctorCode : 'N/A' %></div>
                          <div class="text-break">- Hash: <%= version.recordHash %></div>
                        </div>
                      </div>
                    <% }) %>
                  <% } else { %>
                    <div class="alert alert-light border">Chưa có lịch sử phiên bản.</div>
                  <% } %>
                </div>
                <div class="mt-2">
                  <button id="btnRollback" class="btn btn-danger btn-sm" disabled>
                    <i class="feather icon-rotate-ccw"></i> Rollback về phiên bản đã chọn
                  </button>
                </div>
              </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <hr />
                    <label class="font-weight-bold"> Xác minh tính toàn vẹn (Blockchain)</label>
                    <div class="mt-2">
                        <small class="text-muted">Hash hiện tại của bệnh án (Off-chain):</small>
                        <pre id="offChainHash" class="bg-light p-2 rounded text-monospace">Chưa kiểm tra</pre>
                    </div>

                    <div class="mt-2">
                        <small class="text-muted">Hash lưu trên Blockchain (On-chain):</small>
                        <pre id="onChainHash" class="bg-light p-2 rounded text-monospace">Chưa kiểm tra</pre>
                    </div>

                    <div id="integrityResult" class="mt-2" style="display: none;">
                        <span id="integritySuccess" class="badge badge-success" style="display: none;">
                            <i class="feather icon-check-circle"></i> Dữ liệu toàn vẹn
                        </span>
                        <span id="integrityFail" class="badge badge-danger" style="display: none;">
                            <i class="feather icon-alert-triangle"></i> Phát hiện sai lệch dữ liệu
                        </span>
                    </div>

                </div>
            </div>
            <div class="row mt-3">
              <div class="col-12 text-center">
                <a href="/admin/records" class="btn btn-secondary">Quay lại</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirm Rollback -->
<div class="modal fade" id="rollbackModal" tabindex="-1" role="dialog" aria-labelledby="rollbackModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rollbackModalLabel">Xác nhận Rollback</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Bạn có chắc chắn muốn quay lại phiên bản <b id="lblRollbackVersion"></b> không? <br/>
        Hành động này sẽ tạo ra một phiên bản mới với dữ liệu của phiên bản cũ và cập nhật Hash trên Blockchain.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-danger" id="btnConfirmRollback">Xác nhận Rollback</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    const btn = $("#btnVerifyIntegrity");
    const recordId = btn.data("id");
    const STORAGE_KEY = "lastVerifyIntegrityClick_" + recordId;
    const COOLDOWN_MINUTES = 1;
    const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;
    const ORIGINAL_HTML = '<i class="feather icon-shield"></i> Kiểm tra tính toàn vẹn';

    function updateButtonState() {
      let lastClickTimestamp;
      try {
        lastClickTimestamp = localStorage.getItem(STORAGE_KEY);
      } catch (e) {
        lastClickTimestamp = null;
      }
      
      if (btn.data('intervalId')) {
        clearInterval(btn.data('intervalId'));
        btn.removeData('intervalId');
      }

      if (!lastClickTimestamp) {
        btn.prop("disabled", false).html(ORIGINAL_HTML);
        return;
      }

      const timePassed = Date.now() - parseInt(lastClickTimestamp, 10);

      if (timePassed < COOLDOWN_MS) {
        btn.prop("disabled", true);
        
        const updateTimer = () => {
             const timeLeft = COOLDOWN_MS - (Date.now() - parseInt(lastClickTimestamp, 10));
             if (timeLeft <= 0) {
                 const intervalId = btn.data('intervalId');
                 if(intervalId) clearInterval(intervalId);
                 try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                 updateButtonState();
             } else {
                 const minutes = Math.floor(timeLeft / 60000);
                 const seconds = Math.floor((timeLeft % 60000) / 1000);
                 btn.text(`Vui lòng đợi ${minutes}m ${seconds}s`);
             }
        };

        updateTimer(); 
        const intervalId = setInterval(updateTimer, 1000);
        btn.data('intervalId', intervalId);
      } else {
        try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
        btn.prop("disabled", false).html(ORIGINAL_HTML);
      }
    }

    updateButtonState();

    btn.click(function () {
      try { localStorage.setItem(STORAGE_KEY, Date.now().toString()); } catch (e) {}
      btn.prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> Đang kiểm tra...');
      
      if (btn.data('intervalId')) {
        clearInterval(btn.data('intervalId'));
        btn.removeData('intervalId');
      }

      $("#offChainHash").text("Đang tải...");
      $("#onChainHash").text("Đang tải...");
      $("#integrityResult").hide();
      $("#integritySuccess").hide();
      $("#integrityFail").hide();

      $.post("/admin/medical-records/verify-integrity", { recordId: recordId })
        .done(function (data) {
          if (data.success) {
            $("#offChainHash").text(data.localHash);
            $("#onChainHash").text(data.blockchainHash);
            $("#integrityResult").show();
            if (data.isValid) {
              $("#integritySuccess").show();
              toastr.success("Dữ liệu bệnh án KHỚP với Blockchain.", "Toàn vẹn dữ liệu");
            } else {
              $("#integrityFail").show();
              toastr.error("Dữ liệu bệnh án KHÔNG KHỚP với Blockchain!", "Cảnh báo");
            }
          } else {
            $("#offChainHash").text("Lỗi");
            $("#onChainHash").text("Lỗi");
            toastr.error(data.message, "Lỗi");
          }
        })
        .fail(function () {
          toastr.error("Không thể kết nối đến server.", "Lỗi");
        })
        .always(function () {
          updateButtonState();
        });
    });

    // Rollback
    const recordCurrentVersion = parseInt("<%= record.currentVersion %>") || 0;
    let selectedVersion = null;

    $('input[name="versionSelect"]').change(function() {
      const id = $(this).attr('id');
      const version = parseInt(id.split('_')[1]);
      selectedVersion = version;
      
      if (version && version !== recordCurrentVersion) {
        $('#btnRollback').prop('disabled', false);
      } else {
        $('#btnRollback').prop('disabled', true);
      }
    });

    $('#btnRollback').click(function() {
      if (selectedVersion) {
        $('#lblRollbackVersion').text('#' + selectedVersion);
        $('#rollbackModal').modal('show');
      }
    });

    $('#btnConfirmRollback').click(function() {
      const btnConfirm = $(this);
      btnConfirm.prop('disabled', true).text('Đang xử lý...');

      $.post("/admin/medical-records/rollback", { 
        recordId: "<%= record._id %>", 
        version: selectedVersion 
      })
      .done(function(data) {
        if (data.success) {
          toastr.success("Rollback thành công!", "Thành công");
          setTimeout(() => location.reload(), 1500);
        } else {
          toastr.error(data.message || "Có lỗi xảy ra.", "Lỗi");
          btnConfirm.prop('disabled', false).text('Xác nhận Rollback');
        }
      })
      .fail(function() {
        toastr.error("Lỗi kết nối server.", "Lỗi");
        btnConfirm.prop('disabled', false).text('Xác nhận Rollback');
      });
    });
  });
</script>

<%- include('./partials/footer') %>
